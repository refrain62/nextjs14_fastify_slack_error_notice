# Slackエラー通知システム：仕様と計画書

## 1. 概要

本書は、Next.js 14のAppルーターで作成されたアプリケーションに統合するSlackエラー通知システムの仕様と開発計画を定義するものです。
バックエンドはカスタムサーバーでFastifyとtRPCを利用して構築します。

主な目的は、サーバーサイドで発生した例外を自動的に捕捉し、デバッグに役立つ詳細な通知を、指定されたSlackチャンネルに送信することです。加えて、エラーではないシステムイベント（例：リソース残量警告）もSlackに通知する汎用的な機能を提供します。

## 2. 主な機能

- **エラーの自動捕捉**: tRPCのAPIレイヤーで処理されなかったすべての例外を捕捉します。
- **Slack通知**: 捕捉したエラーを、Botトークンを利用して特定のSlackチャンネルに送信します。
- **汎用的なイベント通知**: エラーとは独立して、システムで発生した任意の事象（例：リソース残量警告）をSlackに通知します。
- **条件付き通知**: HTTP 500番台の致命的なエラーのみを通知するオプションを提供します。
- **データマスキング**: リクエストペイロードに含まれるパスワードなどの機密情報を、Slackへ送信する前にマスク（`****`に置換）します。
- **構造化されたデバッグしやすいメッセージ**: 通知メッセージは可読性の高い構造化された形式とし、メインメッセージで概要を、スレッド内の添付ファイルで完全なスタックトレースを提供します。

## 3. 通知内容

各通知は、メインメッセージと添付ファイルで構成されます。

### 3.1. メインメッセージ（チャンネルへの投稿）

- **タイトル**: `🚨【緊急】サーバーエラーが発生しました` のような、明確で緊急性の高いタイトル。（イベント通知の場合はイベントタイプに応じたタイトル）
- **エラー概要**: `error.name` と `error.message`。（イベント通知の場合はメッセージ内容）
- **リクエストURI**: エラーが発生したAPIエンドポイントの完全なURI。
- **発生日時**: エラー発生時刻のISO 8601形式タイムスタンプ。
- **セッションID**: リクエストから取得したセッションID。
- **ホスト名**: リクエストを処理したサーバーのホスト名。
- **クライアントIP**: リクエスト元のIPアドレス。
- **リクエスト入力値**: tRPCプロシージャの入力ペイロード。機密フィールドをマスクしたJSON形式。

### 3.2. 添付ファイル（スレッドへの投稿）

- **ファイル名**: `stack_trace.txt`（イベント通知の場合は指定されたファイル名）
- **ファイル内容**: 捕捉した例外の完全な `error.stack`。（イベント通知の場合は指定されたファイル内容）

## 4. 開発経緯と前提条件

- **プロジェクト名**: `nextjs14_fastify_slack_error_notice`
- **プロジェクト作成ツール**: `npx create-next-app`
    - `npx create-next-app` を非対話モードで実行し、プロジェクトの土台を構築。
- **パッケージマネージャー**: `pnpm`
- **開発環境の実行**: `ts-node` を用いたTypeScriptの直接実行でモジュール解決の問題が発生したため、開発環境では `nodemon` を使用し、TypeScriptファイルをJavaScriptにコンパイル（`tsc --project tsconfig.server.json`）してからNode.jsで実行する方式を採用。

## 5. アーキテクチャと実装計画

実装は、TypeScriptを用いたモジュール指向かつ関数プログラミングのアプローチで行います。

### ステップ1: プロジェクトの土台構築

1.  **Next.jsプロジェクトの初期化**: `create-next-app` を用いて、新しいNext.js 14のAppルーターのアプリケーションを作成します。
    -   **プロジェクト名**: `nextjs14_fastify_slack_error_notice`
    -   **構成**: TypeScript, App Router, Tailwind CSS, ESLint, `src/` ディレクトリ
2.  **FastifyとtRPCの統合**: 
    -   Fastify, tRPC, および関連ライブラリ（`@trpc/server`, `@trpc/client`, `fastify-plugin`, `@fastify/nextjs` など）を追加します。
    -   Next.jsをFastifyのプラグインとして実行するためのカスタムサーバー（`src/server.ts`）を作成します。
    -   基本的なtRPCバックエンドの構造（`src/server/api/`）をセットアップします。
    -   サーバーサイドTypeScriptコードをCommonJSとしてコンパイルするための `tsconfig.server.json` を設定します。
    -   開発時には `nodemon` を使用し、TypeScriptファイルの変更を監視して自動的にコンパイル・再起動を行うようにします。

### ステップ2: Slack通知コアロジックの実装

1.  **`src/lib/slackMessageFormatter.ts` の作成**: 
    -   `formatErrorForSlack()`: エラー情報とHTTPリクエストのコンテキストを受け取り、Slack APIに渡すためのメッセージオブジェクトを生成します。
    -   `maskSensitiveData()`: `formatErrorForSlack`内部で利用。オブジェクトを再帰的に探索し、**デフォルトで `['password', 'token', 'secret', 'apiKey', 'authorization']` といったキーを持つ値を `****` に置換します。** このリストは将来的に拡張可能です。
2.  **`src/lib/slackNotifier.ts` の作成**: 
    -   `sendErrorToSlack()`:
        -   `@slack/web-api` の `WebClient` を初期化します。
        -   整形されたメインメッセージを投稿し、スレッド内にスタックトレースのテキストファイルを添付します。
    -   `sendSlackMessage()`:
        -   汎用的なSlackメッセージを送信するための関数。メッセージの内容（テキスト、ブロックなど）を引数として受け取り、オプションでスレッド内にファイルを添付できます。

### ステップ3: tRPCミドルウェアとの統合

1.  **`src/server/api/trpc.ts` でのコンテキスト生成**: 
    -   tRPCの `createContext` 関数内で、Fastifyのリクエストオブジェクト (`req`) とレスポンスオブジェクト (`res`) をコンテキストに含めるように設定します。これにより、後続のミドルウェアやプロシージャでリクエスト情報にアクセスできるようになります。
2.  **`src/server/api/middleware/errorNotifier.ts` の作成**: 
    -   `catch` ブロック内で、`ctx.req` からリクエストURI (`req.url`)、クライアントIP (`req.ip`)、ホスト名 (`req.hostname`)、セッションID (`req.session.id` 等) を含むコンテキストオブジェクトを構築します。
    -   このコンテキストと捕捉したエラーを `sendErrorToSlack` 関数に渡します。

### ステップ4: 設定と動作検証

1.  **環境変数**: `.env.local` に、必要なSlackトークン、チャンネルIDを設定します。
2.  **テスト**: 
    -   意図的にエラーを発生させるtRPCエンドポイントを作成し、エラー通知パイプライン全体が期待通りに動作することを検証します。
    -   汎用的なイベント通知を送信するtRPCエンドポイントを作成し、Slackにメッセージが送信されることを検証します。
